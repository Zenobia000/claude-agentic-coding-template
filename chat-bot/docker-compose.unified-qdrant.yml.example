# 統一使用 Qdrant 的配置示例（方案 1）
# 使用方式：cp docker-compose.unified-qdrant.yml.example docker-compose.yml

services:
  backend:
    build:
      context: ./backend
    ports:
      - "8000:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - OLLAMA_BASE_URL=http://ollama:11434
      - QDRANT_URL=http://qdrant:6333
    depends_on:
      - qdrant
      - ollama
    volumes:
      - ./backend:/app
      - /home/os-sunnie.gd.weng/python_workstation/side-project/RAG/RAG_full_tech_overview/papers:/app/papers

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    ports:
      - "8081:8080"
    environment:
      # API 連接
      - OPENAI_API_BASE_URLS=http://backend:8000/v1
      - OPENAI_API_KEYS=${OPENAI_API_KEY}
      - OLLAMA_BASE_URL=http://ollama:11434
      
      # ===== 關鍵配置：使用 Qdrant 而非 ChromaDB =====
      - VECTOR_DB=qdrant
      - QDRANT_URI=http://qdrant:6333
      - QDRANT_API_KEY=  # 如果 Qdrant 有設置密鑰
      
      # RAG 設置
      - ENABLE_RAG_WEB_LOADER_SSL_VERIFICATION=false
      - CHUNK_SIZE=1500
      - CHUNK_OVERLAP=100
      - RAG_TOP_K=5
      
      # Embedding 模型設置
      - RAG_EMBEDDING_MODEL=sentence-transformers/all-MiniLM-L6-v2
      - RAG_EMBEDDING_MODEL_AUTO_UPDATE=true
      
    depends_on:
      - backend
      - ollama
      - qdrant
    volumes:
      - ./open-webui:/app/backend/data

  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - ./qdrant_storage:/qdrant/storage
    environment:
      # Qdrant 配置
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__HTTP_PORT=6333
  
  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ./ollama_data:/root/.ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

# 統一向量庫架構說明：
# 
# 1. 所有文檔（用戶上傳 + 預先索引）都存在 Qdrant
# 2. Open WebUI 通過 VECTOR_DB=qdrant 使用 Qdrant
# 3. Backend RAG API 也使用同一個 Qdrant
# 4. Collection 命名規範：
#    - webui_user_{user_id}  # Open WebUI 用戶文檔
#    - professional_docs     # Backend 預先索引的文檔
# 
# 優點：
# - 單一向量庫，減少資源消耗
# - 數據統一管理
# - Qdrant 性能更好
# 
# 注意：
# - 需要確保 Qdrant 穩定性
# - 建議設置 Qdrant 備份策略

